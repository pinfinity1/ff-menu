services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: "postgresql://myuser:mypassword@db:5432/mydb"
      S3_ENDPOINT_URL: "http://minio:9000"
      S3_ACCESS_KEY_ID: "minioadmin"
      S3_SECRET_ACCESS_KEY: "minioadmin"
      S3_BUCKET_NAME: "ff-menu-images"
      NEXT_PUBLIC_S3_PUBLIC_URL: "http://localhost:9000/ff-menu-images"
    volumes:
      - ./:/app
      - /app/node_modules # این خط برای حل مشکل lightningcss در مک M1/M2 حیاتی است
    depends_on:
      db:
        condition: service_healthy # منتظر می‌ماند تا دیتابیس سالم باشد
      minio-setup:
        condition: service_completed_successfully # منتظر می‌ماند تا MinIO کامل تنظیم شود
    command: >
      bash -c "npx prisma db push && npm run dev"

  db:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: mydb
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    # --- Healthcheck برای دیتابیس اضافه شد ---
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U myuser -d mydb"]
      interval: 5s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    restart: always
    environment:
      MINIO_ROOT_USER: "minioadmin"
      MINIO_ROOT_PASSWORD: "minioadmin"
    volumes:
      - minio_data:/data
      - ./minio-config:/etc/minio/
    ports:
      - "9000:9000"
      - "9001:9001"
    command: server /data --console-address ":9001"
    # --- Healthcheck برای MinIO اضافه شد ---
    healthcheck:
      test: ["CMD", "/usr/bin/mc", "ready", "local"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s # به MinIO 5 ثانیه فرصت اولیه برای شروع به کار می‌دهد

  minio-setup:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy # <-- این خط حیاتی است
    entrypoint: |
      /bin/sh -c "
      echo '...waiting for minio to be healthy';

      # --- اضافه کردن حلقه Retry برای Alias ---
      until /usr/bin/mc alias set myminio http://minio:9000 minioadmin minioadmin; do
        echo '...retrying alias set'
        sleep 1;
      done;

      echo 'Creating bucket...';
      /usr/bin/mc mb myminio/ff-menu-images || true;

      echo 'Setting bucket policy...';
      /usr/bin/mc anonymous set public myminio/ff-menu-images;

      echo 'Setting CORS policy...';
      # --- این راه‌حل نهایی است: اضافه کردن حلقه Retry برای CORS ---
      until /usr/bin/mc cors set myminio/ff-menu-images /etc/minio/cors.json; do
        echo '...retrying CORS set'
        sleep 1;
      done;

      echo 'MinIO setup complete.';
      "
    volumes:
      - ./minio-config:/etc/minio/

volumes:
  postgres_data:
  minio_data:
