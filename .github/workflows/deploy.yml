name: Deploy to Production

on:
    push:
        branches: ["main"]

env:
    # Ù†Ø§Ù… Ø§Ù…ÛŒØ¬ Ø¯Ø§Ú©Ø± (ÙØ±Ù…Øª: ghcr.io/Ù†Ø§Ù…-Ú©Ø§Ø±Ø¨Ø±ÛŒ/Ù†Ø§Ù…-Ø±ÛŒÙ¾Ùˆ)
    IMAGE_NAME: ghcr.io/pinfinity1/ff-menu

jobs:
    # ğŸ—ï¸ Ù…Ø±Ø­Ù„Ù‡ Û±: Ø³Ø§Ø®Øª Ø§ÛŒÙ…ÛŒØ¬ Ø¯Ø± Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ (Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡)
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Log in to the Container registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: ${{ env.IMAGE_NAME }}:latest

    # ğŸš€ Ù…Ø±Ø­Ù„Ù‡ Û²: Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± (Ø±Ø³ØªÙˆØ±Ø§Ù†)
    deploy:
        needs: build-and-push
        runs-on: ubuntu-latest

        steps:
            - name: Execute remote commands via SSH
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: 22
                  script: |
                      # Û±. Ø±ÙØªÙ† Ø¨Ù‡ Ù…Ø³ÛŒØ± Ø¯Ù‚ÛŒÙ‚ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¯Ø± Ø³Ø±ÙˆØ±
                      cd /var/www/ff-menu || exit

                      echo "âœ… Successfully entered directory: $(pwd)"

                      # Û². Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ (Ù…Ø«Ù„ docker-compose.prod.yml)
                      echo "â¬‡ï¸ Pulling git changes..."
                      git pull origin main

                      # Û³. Ù„Ø§Ú¯ÛŒÙ† Ø¨Ù‡ Ø¯Ø§Ú©Ø± Ø¨Ø§ Ú©Ù„ÛŒØ¯ÛŒ Ú©Ù‡ Ø³Ø§Ø®ØªÛŒ (CR_PAT)
                      echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u pinfinity1 --password-stdin

                      # Û´. Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§ÛŒÙ…ÛŒØ¬ Ø¬Ø¯ÛŒØ¯ÛŒ Ú©Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯
                      echo "â¬‡ï¸ Pulling Docker Image..."
                      docker-compose -f docker-compose.yml -f docker-compose.prod.yml pull app

                      # Ûµ. Ø¨Ø§Ù„Ø§ Ø¢ÙˆØ±Ø¯Ù† Ú©Ø§Ù†ØªÛŒÙ†Ø±Ù‡Ø§ Ø¨Ø§ Ø§ÛŒÙ…ÛŒØ¬ Ø¬Ø¯ÛŒØ¯
                      echo "ğŸš€ Restarting App..."
                      docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --force-recreate app

                      # Û¶. Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø± Ù†Ø´Ø¯Ù† Ø­Ø§ÙØ¸Ù‡ Ø³Ø±ÙˆØ±
                      echo "ğŸ§¹ Cleanup..."
                      docker image prune -f
