name: Deploy to Production

# Ø§ÛŒÙ† Ø§Ú©Ø´Ù† ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ú©Ù‡ Ø±ÙˆÛŒ Ø´Ø§Ø®Ù‡ main Ù¾ÙˆØ´ (Push) Ú©Ù†ÛŒØ¯
on:
    push:
        branches: ["main"]

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Execute remote commands via SSH
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: 22
                  script: |
                      # Û±. Ø±ÙØªÙ† Ø¨Ù‡ Ù¾ÙˆØ´Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ (Ù…Ø³ÛŒØ± Ø±Ø§ Ù…Ø·Ø§Ø¨Ù‚ Ø³Ø±ÙˆØ± Ø®ÙˆØ¯ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯)
                      cd /root/ff-menu || exit

                      # Û². Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø² Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨
                      echo "â¬‡ï¸ Pulling latest changes..."
                      git pull origin main

                      # Û³. Ù¾Ø§ÛŒÛŒÙ† Ø¢ÙˆØ±Ø¯Ù† Ú©Ø§Ù†ØªÛŒÙ†Ø±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¯Ø§Ø®Ù„
                      echo "ğŸ›‘ Stopping containers..."
                      docker-compose down

                      # Û´. Ø¨ÛŒÙ„Ø¯ Ùˆ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯
                      # Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…: Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙØ§Ù„Ø³ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø±ÙˆØ´Ù† Ø´ÙˆØ¯
                      echo "ğŸš€ Building and Starting..."
                      export NEXT_PUBLIC_IMAGE_UNOPTIMIZED=false
                      docker-compose up --build -d

                      # Ûµ. Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø§ÛŒÙ…ÛŒØ¬â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ (Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø± Ø´Ø¯Ù† Ø¯ÛŒØ³Ú©)
                      echo "ğŸ§¹ Cleaning up..."
                      docker image prune -f
